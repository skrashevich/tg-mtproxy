# AGENTS.md

## Цель проекта
Telegram-бот продаёт доступ к MTProto proxy через Telegram Stars и автоматически управляет Docker-контейнером `telegrammessenger/proxy`.

Ключевой сценарий:
1. Пользователь выбирает тариф.
2. Оплачивает инвойс в Stars.
3. Бот активирует/продлевает подписку в SQLite.
4. Бот пересоздаёт MTProxy-контейнер с актуальным набором `SECRET`.
5. Пользователь получает `tg://` и `https://t.me/proxy` ссылки.

## Стек и структура
- Язык: TypeScript (Node.js, CommonJS)
- Бот: `telegraf`
- БД: `better-sqlite3` (`data/proxy.db`)
- Планировщик: `node-cron`
- Управление MTProxy: shell-команды Docker из `src/proxy-manager.ts`

Структура:
- `src/index.ts` — вход и запуск бота
- `src/bot.ts` — все команды, оплата, cron-задачи, уведомления админу
- `src/database.ts` — схема и prepared statements SQLite
- `src/proxy-manager.ts` — генерация secret, построение ссылок, перезапуск контейнера, health/stats
- `src/tariffs.ts` — конфиг тарифов

## Команды разработки
- Установка: `npm install`
- Dev-режим: `npm run dev`
- Сборка: `npm run build`
- Прод-запуск после сборки: `npm start`

## Обязательные переменные окружения
Минимум:
- `BOT_TOKEN`
- `ADMIN_ID`
- `SERVER_IP`

Часто используемые:
- `PROXY_PORT` (по умолчанию `443`)
- `PROXY_CONTAINER` (по умолчанию `mtproxy`)
- `MAX_USERS`, `SOFT_LIMIT`
- `RAM_WARN_PERCENT`, `RAM_STOP_PERCENT`
- `PROXY_TAG` (опционально, для docker image env `TAG`)

## Важные инварианты (не ломать)
1. Продажи блокируются при перегрузке RAM (`salesBlocked`) и должны оставаться блокированными до восстановления.
2. После изменения состава активных пользователей прокси должен быть синхронизирован через `proxy.restartWithSecrets()`.
3. При отсутствии активных пользователей контейнер должен останавливаться.
4. `secret` уникален на пользователя и хранится в БД; ссылка всегда строится через `dd`-префикс (`dd<secret>`).
5. Просроченные подписки деактивируются cron-задачей и удаляются из набора secrets при следующем рестарте контейнера.

## Правила изменений
1. Не меняй схему БД без обновления всех связанных запросов в `src/database.ts` и мест вызова в `src/bot.ts`.
2. Любое изменение логики оплаты должно сохранять последовательность: проверка лимитов -> invoice -> pre_checkout -> successful_payment -> запись платежа -> рестарт прокси.
3. Любое изменение форматирования ссылок требует проверки обоих форматов: `tg://proxy` и `https://t.me/proxy`.
4. Изменения cron-задач должны учитывать антиспам админу (в проекте уже есть ограничение на soft-limit уведомления).
5. Новые админ-команды должны быть жёстко ограничены `ctx.from.id === ADMIN_ID`.

## Проверка после изменений
Минимальный чеклист:
1. `npm run build` проходит без ошибок.
2. Базовый smoke по коду:
   - команды `/start`, `/tariffs`, `/status`, `/link` не падают;
   - админские команды недоступны не-админу;
   - при успешной оплате выполняются запись в БД и `restartWithSecrets()`.
3. Если трогали `proxy-manager.ts`, проверить, что команда `docker run` формируется корректно и содержит актуальный `SECRET`.

## Операционные заметки
- Файл БД создаётся автоматически в `data/proxy.db`.
- Для production используется systemd unit из `setup.sh` (`mtproxy-bot.service`).
- Полезные команды на сервере:
  - `sudo systemctl status mtproxy-bot`
  - `sudo journalctl -u mtproxy-bot -f`

## Ограничения текущего репозитория
- Автотесты не настроены.
- Основной источник регрессий — связка `successful_payment` + обновление БД + перезапуск контейнера.
- Любые изменения в этих участках требуют особенно аккуратной ручной проверки.
